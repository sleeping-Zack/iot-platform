<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>IoT 云端可视化</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- 使用国内CDN镜像 -->
  <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/modern-css-reset/1.4.0/reset.min.css">
  <link href="https://fonts.loli.net/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    /* 简单动画 */
    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .status-dot {
      animation: pulse 2s infinite;
    }

    /* 告警级别样式 */
    .alert-level-HIGH {
      background: #f8d7da;
      color: #721c24;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .alert-level-LOW {
      background: #cce5ff;
      color: #004085;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    /* 自定义滚动条 */
    .alert-list-container::-webkit-scrollbar {
      width: 6px;
    }

    .alert-list-container::-webkit-scrollbar-thumb {
      background: #adb5bd;
      border-radius: 3px;
    }
  </style>
  <!-- jQuery -->
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
</head>

<body>
  <div class="container-fluid">
    <!-- 主容器 -->
    <div class="main-container bg-white rounded-4 shadow-lg mx-auto my-4 p-4"
      style="max-width: 1400px; backdrop-filter: blur(10px);">

      <!-- 头部区域 -->
      <div class="header-section text-center mb-4 p-4 rounded-3"
        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h1 class="display-4 fw-bold mb-2">
          <i class="bi bi-cloud-arrow-up me-2"></i>IoT 云端数据可视化
        </h1>
        <p class="lead mb-0">实时监控 · 智能告警 · 数据分析</p>
      </div>

      <!-- 控制面板 -->
      <div class="control-panel card border-0 shadow-sm mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label for="device_code" class="form-label fw-semibold">
                <i class="bi bi-cpu text-primary"></i> 设备代码
              </label>
              <input type="text" class="form-control form-control-lg" id="device_code" value="T-001"
                placeholder="输入设备代码">
            </div>
            <div class="col-md-3">
              <label for="from" class="form-label fw-semibold">
                <i class="bi bi-calendar-event text-success"></i> 起始时间
              </label>
              <input type="text" class="form-control form-control-lg" id="from" placeholder="2025-08-01T00:00:00Z">
            </div>
            <div class="col-md-2">
              <label for="to" class="form-label fw-semibold">
                <i class="bi bi-calendar-check text-info"></i> 结束时间
              </label>
              <input type="text" class="form-control form-control-lg" id="to" placeholder="留空使用当前时间">
            </div>
            <div class="col-md-2">
              <label for="days" class="form-label fw-semibold">
                <i class="bi bi-graph-up text-warning"></i> 统计天数
              </label>
              <select class="form-select form-select-lg" id="days">
                <option value="7" selected>7天</option>
                <option value="14">14天</option>
                <option value="30">30天</option>
              </select>
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-primary btn-lg w-100 shadow-sm" id="loadBtn">
                <i class="bi bi-arrow-clockwise me-1"></i> 加载数据
              </button>
            </div>
          </div>

          <!-- 状态指示器 -->
          <div class="row mt-3">
            <div class="col-12">
              <div class="d-flex align-items-center" id="status-container">
                <div class="status-dot bg-success rounded-circle me-2"
                  style="width: 8px; height: 8px; animation: pulse 2s infinite;"></div>
                <span class="text-muted fw-medium" id="status">就绪</span>
              </div>
              <!-- 消息提示区域 -->
              <div id="alert-messages"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 告警监控区域 -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0 fw-bold">
            <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>实时告警监控
          </h5>
          <span class="badge bg-danger rounded-pill px-3 py-2 fs-6" id="alert-badge"
            style="animation: bounce 1s infinite;">0</span>
        </div>
        <div class="card-body p-0">
          <div class="alert-list-container" style="max-height: 300px; overflow-y: auto;">
            <ul class="list-group list-group-flush" id="alert-list"></ul>
          </div>
        </div>
      </div>

      <!-- 图表区域 -->
      <div class="row g-4">
        <!-- 时间序列图 -->
        <div class="col-lg-8">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-light border-0">
              <h5 class="card-title mb-0 fw-bold">
                <i class="bi bi-graph-up-arrow text-primary me-2"></i>云端时间序列
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-loading text-center py-5 d-none" id="lineChartLoading">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2 text-muted">正在加载图表数据...</p>
              </div>
              <div class="chart-container position-relative" style="height: 400px;">
                <canvas id="lineChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- 日报统计图 -->
        <div class="col-lg-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-light border-0">
              <h5 class="card-title mb-0 fw-bold">
                <i class="bi bi-bar-chart-fill text-success me-2"></i>日报统计
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-loading text-center py-5 d-none" id="barChartLoading">
                <div class="spinner-border text-success" role="status">
                  <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2 text-muted">正在加载统计数据...</p>
              </div>
              <div class="chart-container position-relative" style="height: 400px;">
                <canvas id="barChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    $(document).ready(function () {
      // 全局变量
      let lineChart, barChart;
      let THI = null, TLO = null, lastAlertId = 0;

      // 格式化时间
      const fmtTime = (s) => new Date(s).toLocaleString();

      // 显示消息
      function showMessage(message, type = 'success') {
        const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
        const alertHtml = `<div class="alert ${alertClass} alert-dismissible fade show mt-2" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
        $('#alert-messages').html(alertHtml);
        setTimeout(() => $('.alert').fadeOut(), 3000);
      }

      // 更新状态
      function updateStatus(message, isLoading = false) {
        $('#status').text(message);
        $('.status-dot').toggleClass('bg-warning', isLoading).toggleClass('bg-success', !isLoading);
      }

      // 显示加载动画
      function showLoading(chartType, show) {
        $(`#${chartType}ChartLoading`).toggleClass('d-none', !show);
      }

      // 创建折线图
      function createLineChart(labels, values) {
        const hiLine = THI ? labels.map(() => THI) : null;
        const loLine = TLO ? labels.map(() => TLO) : null;
        const alertMask = values.map(v => ((THI && v > THI) || (TLO && v < TLO)) ? v : null);

        const datasets = [
          { label: '温度(°C)', data: values, borderColor: '#0d6efd', tension: 0.4, pointRadius: 0 }
        ];

        if (alertMask.some(v => v !== null)) {
          datasets.push({
            label: '告警点', data: alertMask, showLine: false, pointRadius: 6,
            pointBackgroundColor: '#dc3545', borderWidth: 0
          });
        }

        if (hiLine) {
          datasets.push({
            label: '高阈值', data: hiLine, borderColor: '#dc3545',
            borderDash: [5, 5], pointRadius: 0
          });
        }

        if (loLine) {
          datasets.push({
            label: '低阈值', data: loLine, borderColor: '#0dcaf0',
            borderDash: [5, 5], pointRadius: 0
          });
        }

        if (lineChart) lineChart.destroy();
        lineChart = new Chart($('#lineChart')[0], {
          type: 'line',
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false }
          }
        });
      }

      // 创建柱状图
      function createBarChart(days, avg, maxv, minv, alerts) {
        if (barChart) barChart.destroy();
        barChart = new Chart($('#barChart')[0], {
          type: 'bar',
          data: {
            labels: days,
            datasets: [
              { label: '平均', data: avg, backgroundColor: '#0d6efd' },
              { label: '最高', data: maxv, backgroundColor: '#198754' },
              { label: '最低', data: minv, backgroundColor: '#ffc107' },
              { label: '告警数', data: alerts, backgroundColor: '#dc3545', yAxisID: 'y1' }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true },
              y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } }
            }
          }
        });
      }

      // 加载数据
      function loadData() {
        const deviceCode = $('#device_code').val().trim();
        const from = $('#from').val().trim();
        const to = $('#to').val().trim();
        const days = $('#days').val();

        if (!deviceCode) {
          showMessage('请输入设备代码', 'error');
          return;
        }

        updateStatus('加载中...', true);
        showLoading('line', true);
        showLoading('bar', true);

        // 并行请求数据
        const requests = [
          $.get(`/api/dev/thresholds/?device_code=${deviceCode}`),
          $.get('/api/cloud/series', { device_code: deviceCode, from, to }),
          $.get('/api/report/daily/series', { device_code: deviceCode, days, from, to })
        ];

        $.when(...requests).done((thresholds, series, daily) => {
          // 处理阈值
          THI = thresholds[0].threshold_hi;
          TLO = thresholds[0].threshold_lo;

          // 处理时间序列
          const labels = series[0].map(p => fmtTime(p.ts));
          const values = series[0].map(p => p.value);
          createLineChart(labels, values);
          showLoading('line', false);

          // 处理日报数据
          const daysData = daily[0];
          const daysL = daysData.map(x => x.day);
          const avg = daysData.map(x => x.avg_value || 0);
          const maxv = daysData.map(x => x.max_value || 0);
          const minv = daysData.map(x => x.min_value || 0);
          const alerts = daysData.map(x => x.alert_count || 0);
          createBarChart(daysL, avg, maxv, minv, alerts);
          showLoading('bar', false);

          updateStatus(`✅ 加载完成：序列 ${series[0].length} 点，日报 ${daysData.length} 天`);
          showMessage(`数据加载成功！序列 ${series[0].length} 点，日报 ${daysData.length} 天`);
        }).fail((xhr) => {
          updateStatus(`❌ 加载失败`);
          showMessage(`加载失败：${xhr.statusText}`, 'error');
          showLoading('line', false);
          showLoading('bar', false);
        });
      }

      // 轮询告警
      function pollAlerts() {
        const deviceCode = $('#device_code').val().trim();
        if (!deviceCode) return;

        $.get('/api/alerts/recent/', { device_code: deviceCode, limit: 20 })
          .done((alerts) => {
            const $list = $('#alert-list');
            const $badge = $('#alert-badge');

            $list.empty();
            if (alerts.length === 0) {
              $list.html('<li class="list-group-item text-center text-muted py-4"><i class="bi bi-check-circle me-2"></i>暂无告警数据</li>');
            } else {
              alerts.forEach(alert => {
                const levelClass = alert.level === 'HIGH' ? 'alert-level-HIGH' : 'alert-level-LOW';
                const $item = $(`
                  <li class="list-group-item alert-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span class="${levelClass}">${alert.level}</span>
                      <small class="text-muted">${alert.ts}</small>
                    </div>
                    <div class="fw-medium"><i class="bi bi-thermometer me-1"></i>值：${alert.value || '-'} ℃</div>
                    <small class="text-muted">${alert.message || '无详细信息'}</small>
                  </li>
                `);
                $list.append($item);
              });
            }

            // 更新角标
            const maxId = alerts.length ? alerts[0].id : lastAlertId;
            if (maxId > lastAlertId) {
              const unread = maxId - lastAlertId;
              lastAlertId = maxId;
              $badge.text(unread);
              loadData(); // 有新告警时刷新图表
            } else {
              $badge.text(0);
            }
          });
      }

      // 事件绑定
      $('#loadBtn').click(function () {
        $(this).prop('disabled', true);
        loadData();
        setTimeout(() => $(this).prop('disabled', false), 2000);
      });

      // 回车键加载
      $('#device_code, #from, #to').keypress(function (e) {
        if (e.which === 13) loadData();
      });

      // 初始化
      loadData();
      pollAlerts();
      setInterval(loadData, 10000);    // 每10秒刷新数据
      setInterval(pollAlerts, 1500);   // 每1.5秒检查告警
    });
  </script>
</body>

</html>