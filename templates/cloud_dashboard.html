<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IoT 云端可视化</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-css-reset/dist/reset.min.css">
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif; padding:16px;}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; align-items:center;}
    .card{border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:16px; box-shadow: 0 1px 2px rgba(0,0,0,.04);}
    .row{display:grid; grid-template-columns: 1fr; gap:16px;}
    @media(min-width: 900px){ .row{ grid-template-columns: 2fr 1fr; } }
    .muted{color:#6b7280; font-size:12px}
    button{padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer}
    input,select{padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <h1>IoT 云端数据可视化</h1>
  <div class="toolbar card">
    <label>设备代码：
      <input id="device_code" value="T-001" />
    </label>
    <label>起始时间 (ISO)：
      <input id="from" placeholder="2025-08-01T00:00:00Z" />
    </label>
    <label>结束时间 (ISO)：
      <input id="to" placeholder="2025-08-21T23:59:59Z" />
    </label>
    <label>近几天（日汇总）：
      <select id="days">
        <option value="7" selected>7</option>
        <option value="14">14</option>
        <option value="30">30</option>
      </select>
    </label>
    <button id="loadBtn">加载</button>
    <span class="muted" id="status"></span>
  </div>

  <div class="row">
    <div class="card">
      <h3>云端时间序列</h3>
      <canvas id="lineChart"></canvas>
    </div>
    <div class="card">
      <h3>日报统计</h3>
      <canvas id="barChart"></canvas>
    </div>
  </div>

  <script>
    const fmtTime = (s)=>new Date(s).toLocaleString();
    let lineChart, barChart;

    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    function upsertLine(labels, values){
      const ctx = document.getElementById('lineChart');
      if(lineChart) lineChart.destroy();
      lineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{ label: '温度(°C)', data: values, tension: .2 }]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          scales: { x: { ticks: { maxRotation: 0, autoSkip: true } } }
        }
      });
    }

    function upsertBars(days, avg, maxv, minv, alerts){
      const ctx = document.getElementById('barChart');
      if(barChart) barChart.destroy();
      barChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: days,
          datasets: [
            { label: '平均', data: avg },
            { label: '最高', data: maxv },
            { label: '最低', data: minv },
            { label: '告警数', data: alerts, yAxisID: 'y1' }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true },
            y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } }
          }
        }
      });
    }

    async function load(){
      const d = document.getElementById('device_code').value.trim();
      const from = document.getElementById('from').value.trim();
      const to   = document.getElementById('to').value.trim();
      const days = document.getElementById('days').value;

      const status = document.getElementById('status');
      status.textContent = '加载中...';

      try{
        const qsSeries = new URLSearchParams({ device_code: d });
        if(from) qsSeries.set('from', from);
        if(to)   qsSeries.set('to', to);

        const series = await fetchJSON(`/api/cloud/series?${qsSeries.toString()}`);
        const labels = series.map(p => fmtTime(p.ts));
        const values = series.map(p => p.value);
        upsertLine(labels, values);
        const qsDaily = new URLSearchParams({ device_code: d, days });
        if (from) qsDaily.set('from', from);
        if (to)   qsDaily.set('to', to);
        const daily = await fetchJSON(`/api/report/daily/series?${qsDaily.toString()}`);
        const daysL = daily.map(x => x.day);
        const avg   = daily.map(x => x.avg_value ?? 0);
        const maxv  = daily.map(x => x.max_value ?? 0);
        const minv  = daily.map(x => x.min_value ?? 0);
        const alerts= daily.map(x => x.alert_count ?? 0);
        upsertBars(daysL, avg, maxv, minv, alerts);

        status.textContent = `加载完成：序列 ${series.length} 点，日报 ${daily.length} 天`;
      }catch(e){
        status.textContent = `加载失败：${e.message}`;
        console.error(e);
      }
    }

    document.getElementById('loadBtn').addEventListener('click', load);
    // 页面载入时自动加载一次（可选）
    load();

    // 每 15 秒自动刷新（演示用）
    setInterval(load, 15000);
  </script>
</body>
</html>
